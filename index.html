<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BeyLab X - Archivio e Strategia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Custom scrollbar for a cleaner look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #888; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555; 
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 400px;
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(229, 231, 235, 0.5);
        }
        .stat-bar-fill {
            transition: width 1s ease-in-out;
        }
    </style>
    <!-- Chosen Palette: Tech Lab Clean - White/Gray backgrounds with Slate text and vivid accents (Blue/Green/Red) for data visualization. -->
    <!-- Application Structure Plan: 
         1. Header: Simple branding.
         2. Inventory Module: Input field for 'Stock Combos' (simulating recognition) which breaks down into Parts. Visual list of owned parts.
         3. Builder Module: Three dropdowns (Blade, Ratchet, Bit) dependent on Inventory. Live stat preview.
         4. Analysis Module: Radar Chart (Chart.js) + Algorithmic Text Evaluation.
         5. Tournament Deck: 3 Slots to 'Save' completed builds.
         Why this structure? It mirrors the physical workflow: Buy -> Sort -> Build -> Test -> Compete.
    -->
    <!-- Visualization & Content Choices:
         - Radar Chart: Perfect for RPG-style stats (Attack/Defense/Stamina/Dash/Burst). Goal: Inform & Compare.
         - Progress Bars: For individual part stats. Goal: Compare.
         - Dynamic Text: For the 'Motivation/Evaluation'. Goal: Inform.
         - Interactive Lists: For the Inventory. Goal: Organize.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
</head>
<body class="bg-slate-50 text-slate-800 font-sans selection:bg-blue-200">

    <!-- Navbar -->
    <nav class="sticky top-0 z-50 bg-white border-b border-slate-200 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center gap-3">
                    <div class="h-8 w-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold text-xl">X</div>
                    <span class="font-bold text-xl tracking-tight text-slate-900">BeyLab <span class="text-blue-600">Architect</span></span>
                </div>
                <div class="flex space-x-8 items-center hidden md:flex">
                    <a href="#inventory" class="text-slate-500 hover:text-blue-600 font-medium transition-colors">Archivio</a>
                    <a href="#builder" class="text-slate-500 hover:text-blue-600 font-medium transition-colors">Officina & Analisi</a>
                    <a href="#deck" class="text-slate-500 hover:text-blue-600 font-medium transition-colors">Deck Torneo</a>
                </div>
                <!-- Mobile menu button placeholder (simplified) -->
                <div class="flex items-center md:hidden">
                    <button class="text-slate-500 hover:text-blue-600 font-bold">Menu</button>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-12">

        <!-- Intro Section -->
        <section class="text-center space-y-4">
            <h1 class="text-4xl font-extrabold text-slate-900 tracking-tight sm:text-5xl">
                Costruisci. Analizza. <span class="text-blue-600">Vinci.</span>
            </h1>
            <p class="max-w-2xl mx-auto text-lg text-slate-600">
                Benvenuto nel tuo laboratorio digitale. Inserisci i Beyblade che acquisti per popolare l'archivio parti, assembla combo ottimizzate e crea il tuo Deck da torneo perfetto con valutazioni in tempo reale.
            </p>
        </section>

        <!-- SECTION 1: INVENTORY (ARCHIVE) -->
        <section id="inventory" class="bg-white rounded-2xl shadow-lg border border-slate-100 overflow-hidden">
            <div class="p-6 md:p-8 border-b border-slate-100 bg-slate-50/50">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-800">Archivio Componenti</h2>
                        <p class="text-sm text-slate-500 mt-1">
                            Aggiungi i tuoi acquisti. Il sistema "smonta" automaticamente i Beyblade stock nei loro componenti base (Blade, Ratchet, Bit).
                        </p>
                    </div>
                    
                    <!-- Input Area -->
                    <div class="flex w-full md:w-auto gap-2">
                        <select id="stockComboSelect" class="block w-full rounded-md border-0 py-2.5 px-4 text-slate-900 ring-1 ring-inset ring-slate-300 focus:ring-2 focus:ring-blue-600 sm:text-sm sm:leading-6 bg-white shadow-sm">
                            <option value="" disabled selected>Seleziona un acquisto...</option>
                            <!-- Populated via JS -->
                        </select>
                        <button id="addStockBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-md shadow-md transition-all hover:shadow-lg active:scale-95">
                            + Aggiungi
                        </button>
                    </div>
                </div>
            </div>

            <!-- Inventory Grid -->
            <div class="p-6 md:p-8 grid grid-cols-1 md:grid-cols-3 gap-8">
                
                <!-- Blades Column -->
                <div class="space-y-4">
                    <div class="flex items-center gap-2 mb-2">
                        <div class="w-2 h-8 bg-red-500 rounded-full"></div>
                        <h3 class="font-bold text-lg">Blades (Strato)</h3>
                    </div>
                    <ul id="inventory-blades" class="space-y-2 h-64 overflow-y-auto pr-2">
                        <!-- Items injected here -->
                        <li class="p-4 text-center text-slate-400 bg-slate-50 rounded border border-dashed border-slate-200">Nessuna Blade posseduta</li>
                    </ul>
                </div>

                <!-- Ratchets Column -->
                <div class="space-y-4">
                    <div class="flex items-center gap-2 mb-2">
                        <div class="w-2 h-8 bg-yellow-500 rounded-full"></div>
                        <h3 class="font-bold text-lg">Ratchets (Cricchetto)</h3>
                    </div>
                    <ul id="inventory-ratchets" class="space-y-2 h-64 overflow-y-auto pr-2">
                         <li class="p-4 text-center text-slate-400 bg-slate-50 rounded border border-dashed border-slate-200">Nessun Ratchet posseduto</li>
                    </ul>
                </div>

                <!-- Bits Column -->
                <div class="space-y-4">
                    <div class="flex items-center gap-2 mb-2">
                        <div class="w-2 h-8 bg-green-500 rounded-full"></div>
                        <h3 class="font-bold text-lg">Bits (Punta)</h3>
                    </div>
                    <ul id="inventory-bits" class="space-y-2 h-64 overflow-y-auto pr-2">
                         <li class="p-4 text-center text-slate-400 bg-slate-50 rounded border border-dashed border-slate-200">Nessun Bit posseduto</li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- SECTION 2: WORKSHOP (BUILDER & ANALYSIS) -->
        <section id="builder" class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <!-- Builder Controls (Left Panel) -->
            <div class="lg:col-span-5 space-y-6">
                <div class="bg-white rounded-2xl shadow-lg border border-slate-100 p-6 md:p-8">
                    <h2 class="text-2xl font-bold text-slate-800 mb-6 flex items-center gap-2">
                        <span>üõ†Ô∏è</span> Officina
                    </h2>
                    <p class="text-sm text-slate-500 mb-6">
                        Seleziona le parti dal tuo inventario per creare una combo. Il sistema calcoler√† le sinergie.
                    </p>

                    <div class="space-y-5">
                        <!-- Blade Selector -->
                        <div>
                            <label class="block text-sm font-medium leading-6 text-slate-900 mb-1">Blade (Anello di Contatto)</label>
                            <select id="build-blade" class="block w-full rounded-md border-0 py-3 px-3 text-slate-900 shadow-sm ring-1 ring-inset ring-slate-300 focus:ring-2 focus:ring-blue-600 bg-slate-50">
                                <option value="">-- Seleziona Blade --</option>
                            </select>
                            <p class="text-xs text-slate-500 mt-1" id="desc-blade">Seleziona per vedere le info.</p>
                        </div>

                        <!-- Ratchet Selector -->
                        <div>
                            <label class="block text-sm font-medium leading-6 text-slate-900 mb-1">Ratchet (Altezza & Burst)</label>
                            <select id="build-ratchet" class="block w-full rounded-md border-0 py-3 px-3 text-slate-900 shadow-sm ring-1 ring-inset ring-slate-300 focus:ring-2 focus:ring-blue-600 bg-slate-50">
                                <option value="">-- Seleziona Ratchet --</option>
                            </select>
                             <p class="text-xs text-slate-500 mt-1" id="desc-ratchet">...</p>
                        </div>

                        <!-- Bit Selector -->
                        <div>
                            <label class="block text-sm font-medium leading-6 text-slate-900 mb-1">Bit (Movimento)</label>
                            <select id="build-bit" class="block w-full rounded-md border-0 py-3 px-3 text-slate-900 shadow-sm ring-1 ring-inset ring-slate-300 focus:ring-2 focus:ring-blue-600 bg-slate-50">
                                <option value="">-- Seleziona Bit --</option>
                            </select>
                             <p class="text-xs text-slate-500 mt-1" id="desc-bit">...</p>
                        </div>
                    </div>

                    <div class="mt-8 pt-6 border-t border-slate-100 flex gap-4">
                        <button id="analyzeBtn" class="flex-1 bg-slate-900 text-white font-bold py-3 px-4 rounded-lg shadow hover:bg-slate-800 transition-colors">
                            Analizza Build
                        </button>
                        <button id="resetBuildBtn" class="px-4 py-3 text-slate-500 hover:text-red-500 font-medium transition-colors">
                            Reset
                        </button>
                    </div>
                </div>

                <!-- Quick Stats Box -->
                <div class="bg-blue-50 rounded-xl p-6 border border-blue-100 hidden" id="quick-stats-panel">
                    <h3 class="font-bold text-blue-900 mb-2">Peso Totale Stimato</h3>
                    <div class="flex items-end gap-2">
                        <span class="text-4xl font-black text-blue-600" id="total-weight">0</span>
                        <span class="text-blue-400 font-medium mb-1">grammi</span>
                    </div>
                </div>
            </div>

            <!-- Analysis & Visualization (Right Panel) -->
            <div class="lg:col-span-7">
                <div class="bg-white rounded-2xl shadow-lg border border-slate-100 p-6 md:p-8 h-full flex flex-col">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-slate-800">Valutazione Build</h2>
                        <div id="grade-badge" class="hidden w-16 h-16 rounded-full bg-slate-100 flex items-center justify-center text-3xl font-black text-slate-300 border-4 border-slate-200">
                            -
                        </div>
                    </div>

                    <!-- Chart Container -->
                    <div class="chart-container mb-6 flex-grow flex items-center justify-center bg-slate-50 rounded-xl border border-slate-100">
                        <canvas id="statsRadar"></canvas>
                        <div id="chart-placeholder" class="absolute inset-0 flex items-center justify-center text-slate-400 text-sm">
                            Seleziona 3 parti per vedere il grafico
                        </div>
                    </div>

                    <!-- AI Analysis Text -->
                    <div id="analysis-text" class="bg-slate-50 rounded-xl p-5 border-l-4 border-slate-300 text-slate-600 text-sm leading-relaxed min-h-[100px]">
                        <p class="italic text-slate-400">Completa la build per ricevere il commento tecnico e la motivazione strategica.</p>
                    </div>

                    <!-- Add to Deck Button -->
                    <button id="addToDeckBtn" disabled class="mt-6 w-full py-4 rounded-xl border-2 border-dashed border-slate-300 text-slate-400 font-bold hover:border-blue-500 hover:text-blue-600 hover:bg-blue-50 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                        + Aggiungi al Deck Torneo
                    </button>
                </div>
            </div>
        </section>

        <!-- SECTION 3: TOURNAMENT DECK -->
        <section id="deck" class="space-y-6">
            <div class="flex items-center gap-4">
                <h2 class="text-2xl font-bold text-slate-800">Deck Torneo (3on3)</h2>
                <span class="bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded">Ready to Battle</span>
            </div>
            <p class="text-slate-500">
                La tua selezione finale. Assicurati di non ripetere parti se giochi con regole ufficiali WBO/Takara Tomy.
            </p>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="deck-grid">
                <!-- Slot 1 -->
                <div class="deck-slot bg-white p-6 rounded-2xl shadow border border-slate-200 min-h-[200px] flex flex-col justify-center items-center text-center relative group">
                    <div class="absolute top-2 left-3 text-slate-200 text-6xl font-black z-0 select-none">1</div>
                    <div class="z-10 w-full relative">
                        <div class="empty-state">
                            <span class="block text-4xl mb-2">üõ°Ô∏è</span>
                            <span class="text-slate-400 font-medium">Slot Vuoto</span>
                        </div>
                        <div class="filled-state hidden text-left">
                             <!-- JS populates this -->
                        </div>
                    </div>
                </div>

                <!-- Slot 2 -->
                <div class="deck-slot bg-white p-6 rounded-2xl shadow border border-slate-200 min-h-[200px] flex flex-col justify-center items-center text-center relative group">
                    <div class="absolute top-2 left-3 text-slate-200 text-6xl font-black z-0 select-none">2</div>
                    <div class="z-10 w-full relative">
                         <div class="empty-state">
                            <span class="block text-4xl mb-2">‚öîÔ∏è</span>
                            <span class="text-slate-400 font-medium">Slot Vuoto</span>
                        </div>
                        <div class="filled-state hidden text-left"></div>
                    </div>
                </div>

                <!-- Slot 3 -->
                <div class="deck-slot bg-white p-6 rounded-2xl shadow border border-slate-200 min-h-[200px] flex flex-col justify-center items-center text-center relative group">
                    <div class="absolute top-2 left-3 text-slate-200 text-6xl font-black z-0 select-none">3</div>
                    <div class="z-10 w-full relative">
                         <div class="empty-state">
                            <span class="block text-4xl mb-2">üå™Ô∏è</span>
                            <span class="text-slate-400 font-medium">Slot Vuoto</span>
                        </div>
                        <div class="filled-state hidden text-left"></div>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-end">
                <button onclick="window.print()" class="text-slate-500 hover:text-slate-900 font-medium flex items-center gap-2">
                    üñ®Ô∏è Stampa Deck List
                </button>
            </div>
        </section>

    </main>

    <footer class="bg-white border-t border-slate-200 mt-20 py-12">
        <div class="max-w-7xl mx-auto px-4 text-center text-slate-400 text-sm">
            <p>&copy; 2025 BeyLab X Manager. Fan made tool.</p>
        </div>
    </footer>

    <script>
        // --- DATA DATABASE (Simulated) ---
        // This acts as the recognition engine. 
        // We define the base stats for Blades, Ratchets, and Bits.
        
        const PARTS_DB = {
            blades: {
                "Dran Sword": { type: "Attack", weight: 35, stats: { atk: 90, def: 30, sta: 20, burstRes: 60 }, desc: "Lama aggressiva a 3 punti di contatto. Eccelle nel KO." },
                "Hells Scythe": { type: "Balance", weight: 33, stats: { atk: 50, def: 50, sta: 60, burstRes: 70 }, desc: "Bilanciata con ottima capacit√† di parry." },
                "Wizard Arrow": { type: "Stamina", weight: 32, stats: { atk: 20, def: 30, sta: 95, burstRes: 50 }, desc: "Forza centrifuga elevata per massima durata." },
                "Knight Shield": { type: "Defense", weight: 34, stats: { atk: 30, def: 85, sta: 40, burstRes: 80 }, desc: "Forma smussata per assorbire gli impatti." },
                "Shark Edge": { type: "Attack", weight: 34, stats: { atk: 95, def: 20, sta: 15, burstRes: 50 }, desc: "Lama per uppercut estremi. Alto rischio." },
                "Viper Tail": { type: "Stamina", weight: 33, stats: { atk: 45, def: 40, sta: 80, burstRes: 60 }, desc: "Lama che destabilizza l'avversario." },
                "Leon Claw": { type: "Balance", weight: 32, stats: { atk: 60, def: 40, sta: 50, burstRes: 65 }, desc: "Ibrido attacco/difesa." },
                "Rhino Horn": { type: "Defense", weight: 31, stats: { atk: 40, def: 75, sta: 30, burstRes: 90 }, desc: "Compatta e densa, difficile da spostare." },
                "Dran Dagger": { type: "Attack", weight: 34, stats: { atk: 85, def: 35, sta: 30, burstRes: 60 }, desc: "Multi-hit barrage attacks." },
                "Hells Chain": { type: "Balance", weight: 33, stats: { atk: 40, def: 60, sta: 60, burstRes: 75 }, desc: "Assorbe colpi e contrattacca." },
                "Phoenix Wing": { type: "Attack", weight: 38, stats: { atk: 98, def: 40, sta: 25, burstRes: 55 }, desc: "Lama pesante rivestita in metallo. Top tier." },
                "Wyvern Gale": { type: "Stamina", weight: 33, stats: { atk: 25, def: 45, sta: 90, burstRes: 60 }, desc: "Aerodinamica per ridurre l'attrito dell'aria." }
            },
            ratchets: {
                "3-60": { height: "Low", points: 3, weight: 6, stats: { burstRes: 80, stability: 70 }, desc: "Basso profilo, 3 punti. Standard solido." },
                "4-60": { height: "Low", points: 4, weight: 6.5, stats: { burstRes: 60, stability: 80 }, desc: "Basso profilo, 4 punti. Buon bilanciamento." },
                "5-60": { height: "Low", points: 5, weight: 7, stats: { burstRes: 90, stability: 60 }, desc: "Basso, 5 punti. Alta massa e resistenza al burst." },
                "3-80": { height: "High", points: 3, weight: 7, stats: { burstRes: 50, stability: 50 }, desc: "Alto profilo. Rischio burst maggiore ma buoni smash." },
                "4-80": { height: "High", points: 4, weight: 7.5, stats: { burstRes: 40, stability: 60 }, desc: "Alto, 4 punti." },
                "5-80": { height: "High", points: 5, weight: 8, stats: { burstRes: 70, stability: 40 }, desc: "Alto, pesante. Ottimo per spin finish." },
                "9-60": { height: "Low", points: 9, weight: 7.5, stats: { burstRes: 85, stability: 85 }, desc: "Molti punti di contatto, difesa circolare." }
            },
            bits: {
                "F (Flat)": { type: "Attack", stats: { speed: 100, sta: 10, def: 20, dash: 100 }, desc: "Movimento aggressivo sulla X-Line." },
                "T (Taper)": { type: "Attack", stats: { speed: 80, sta: 40, def: 30, dash: 80 }, desc: "Attacco controllato, conserva un po' di stamina." },
                "B (Ball)": { type: "Stamina", stats: { speed: 10, sta: 100, def: 40, dash: 10 }, desc: "Massima stabilit√† e tempo di rotazione." },
                "N (Needle)": { type: "Defense", stats: { speed: 10, sta: 60, def: 90, dash: 20 }, desc: "Punta fine per restare al centro e resistere ai KO." },
                "HN (High Needle)": { type: "Defense", stats: { speed: 10, sta: 50, def: 85, dash: 20 }, desc: "Needle pi√π alta per parry dall'alto." },
                "O (Orb)": { type: "Stamina", stats: { speed: 20, sta: 90, def: 50, dash: 15 }, desc: "Sfera piccola, movimento pi√π agile di Ball." },
                "P (Point)": { type: "Balance", stats: { speed: 60, sta: 50, def: 40, dash: 60 }, desc: "Cambia comportamento a seconda dell'inclinazione." },
                "LF (Low Flat)": { type: "Attack", stats: { speed: 100, sta: 5, def: 15, dash: 100 }, desc: "Pi√π bassa della Flat, attacco ancora pi√π aggressivo." },
                "GF (Gear Flat)": { type: "Attack", stats: { speed: 110, sta: 0, def: 10, dash: 110 }, desc: "Ingranaggio enorme per velocit√† estrema." },
                "GP (Gear Point)": { type: "Balance", stats: { speed: 70, sta: 40, def: 30, dash: 70 }, desc: "Versione Gear della Point." },
                "R (Rush)": { type: "Attack", stats: { speed: 85, sta: 30, def: 25, dash: 90 }, desc: "Giri veloci e continui attacchi piccoli." }
            }
        };

        // Stock Combos for "Recognition"
        const STOCK_COMBOS = [
            { name: "Dran Sword 3-60F", parts: ["Dran Sword", "3-60", "F (Flat)"] },
            { name: "Hells Scythe 4-60T", parts: ["Hells Scythe", "4-60", "T (Taper)"] },
            { name: "Wizard Arrow 4-80B", parts: ["Wizard Arrow", "4-80", "B (Ball)"] },
            { name: "Knight Shield 3-80N", parts: ["Knight Shield", "3-80", "N (Needle)"] },
            { name: "Shark Edge 3-60LF", parts: ["Shark Edge", "3-60", "LF (Low Flat)"] },
            { name: "Leon Claw 5-60P", parts: ["Leon Claw", "5-60", "P (Point)"] },
            { name: "Viper Tail 5-80O", parts: ["Viper Tail", "5-80", "O (Orb)"] },
            { name: "Rhino Horn 3-80S", parts: ["Rhino Horn", "3-80", "N (Needle)"] }, // Assuming S maps to Needle-ish logic for this demo
            { name: "Dran Dagger 4-60R", parts: ["Dran Dagger", "4-60", "R (Rush)"] },
            { name: "Phoenix Wing 9-60GF", parts: ["Phoenix Wing", "9-60", "GF (Gear Flat)"] },
            { name: "Wyvern Gale 5-60GB", parts: ["Wyvern Gale", "5-60", "B (Ball)"] } // Simplified
        ];

        // --- STATE MANAGEMENT ---
        const state = {
            inventory: {
                blades: {},
                ratchets: {},
                bits: {}
            },
            currentBuild: {
                blade: null,
                ratchet: null,
                bit: null
            },
            deck: [null, null, null]
        };

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            populateStockSelect();
            initChart();
            renderInventory();
            setupEventListeners();
        });

        // --- CORE FUNCTIONS ---

        function populateStockSelect() {
            const select = document.getElementById('stockComboSelect');
            STOCK_COMBOS.forEach(combo => {
                const opt = document.createElement('option');
                opt.value = JSON.stringify(combo.parts);
                opt.textContent = combo.name;
                select.appendChild(opt);
            });
        }

        function addToInventory(partsArray) {
            const [blade, ratchet, bit] = partsArray;
            
            // Helper to safe increment
            const inc = (cat, item) => state.inventory[cat][item] = (state.inventory[cat][item] || 0) + 1;
            
            inc('blades', blade);
            inc('ratchets', ratchet);
            inc('bits', bit);

            renderInventory();
            updateBuilderDropdowns();
            
            // Visual feedback
            alert(`Aggiunto all'inventario:\nBlade: ${blade}\nRatchet: ${ratchet}\nBit: ${bit}`);
        }

        function renderInventory() {
            const renderList = (category, containerId, dbCat) => {
                const ul = document.getElementById(containerId);
                ul.innerHTML = '';
                const items = state.inventory[category];
                
                if (Object.keys(items).length === 0) {
                    ul.innerHTML = `<li class="p-4 text-center text-slate-400 bg-slate-50 rounded border border-dashed border-slate-200 text-sm">Nessun componente</li>`;
                    return;
                }

                for (const [name, count] of Object.entries(items)) {
                    if (count > 0) {
                        const li = document.createElement('li');
                        li.className = "flex justify-between items-center bg-white p-3 rounded border border-slate-200 shadow-sm text-sm";
                        
                        // Get type color
                        let typeColor = "bg-slate-200";
                        if (category === 'blades' && PARTS_DB.blades[name]) {
                            const t = PARTS_DB.blades[name].type;
                            if(t === 'Attack') typeColor = 'bg-red-100 text-red-700';
                            if(t === 'Stamina') typeColor = 'bg-yellow-100 text-yellow-700';
                            if(t === 'Defense') typeColor = 'bg-green-100 text-green-700';
                            if(t === 'Balance') typeColor = 'bg-purple-100 text-purple-700';
                        }

                        li.innerHTML = `
                            <div class="flex items-center gap-3">
                                <span class="text-xs font-bold px-2 py-1 rounded ${typeColor}">${PARTS_DB[category][name]?.type?.substring(0,3).toUpperCase() || 'UNK'}</span>
                                <span class="font-medium text-slate-700">${name}</span>
                            </div>
                            <span class="bg-slate-800 text-white text-xs font-bold px-2 py-1 rounded-full">x${count}</span>
                        `;
                        ul.appendChild(li);
                    }
                }
            };

            renderList('blades', 'inventory-blades', 'blades');
            renderList('ratchets', 'inventory-ratchets', 'ratchets');
            renderList('bits', 'inventory-bits', 'bits');
        }

        function updateBuilderDropdowns() {
            const populate = (id, category, currentSelection) => {
                const sel = document.getElementById(id);
                // Keep the first option (-- Select --)
                sel.innerHTML = `<option value="">-- Seleziona ${id.split('-')[1]} --</option>`;
                
                for (const name of Object.keys(state.inventory[category])) {
                    const opt = document.createElement('option');
                    opt.value = name;
                    opt.textContent = `${name} (x${state.inventory[category][name]})`;
                    sel.appendChild(opt);
                }
                if (currentSelection) sel.value = currentSelection;
            };

            populate('build-blade', 'blades', state.currentBuild.blade);
            populate('build-ratchet', 'ratchets', state.currentBuild.ratchet);
            populate('build-bit', 'bits', state.currentBuild.bit);
        }

        // --- ANALYSIS LOGIC ---

        function calculateBuild() {
            const b = state.currentBuild.blade;
            const r = state.currentBuild.ratchet;
            const bi = state.currentBuild.bit;

            if (!b || !r || !bi) return null;

            const bData = PARTS_DB.blades[b];
            const rData = PARTS_DB.ratchets[r];
            const biData = PARTS_DB.bits[bi];

            // Normalize and Sum Stats
            // Base values:
            // Attack = Blade Atk + Bit Speed + (Ratchet Weight * 0.5)
            // Defense = Blade Def + Bit Def + Ratchet Stability
            // Stamina = Blade Sta + Bit Sta + (Low Ratchet Penalty/Bonus)
            // Burst Res = Blade Res + Ratchet Res + Bit Dash (Inverse)

            const totalWeight = bData.weight + rData.weight + 2.5; // 2.5 is avg bit weight (simplified)

            const stats = {
                attack: (bData.stats.atk * 0.6) + (biData.stats.speed * 0.3) + (biData.stats.dash * 0.1),
                defense: (bData.stats.def * 0.6) + (biData.stats.def * 0.3) + (rData.stats.stability * 0.1),
                stamina: (bData.stats.sta * 0.6) + (biData.stats.sta * 0.4),
                weight: (totalWeight / 50) * 100, // Normalize weight to 100 scale (max approx 50g)
                burstRes: (bData.stats.burstRes * 0.4) + (rData.stats.burstRes * 0.6) 
            };
            
            // Caps
            Object.keys(stats).forEach(k => stats[k] = Math.min(100, Math.max(0, stats[k])));

            return { stats, raw: { bData, rData, biData, totalWeight } };
        }

        function analyzeBuild() {
            const data = calculateBuild();
            const btn = document.getElementById('addToDeckBtn');
            const placeholder = document.getElementById('chart-placeholder');
            const analysisText = document.getElementById('analysis-text');
            const gradeBadge = document.getElementById('grade-badge');
            const weightDisplay = document.getElementById('total-weight');
            const qsPanel = document.getElementById('quick-stats-panel');

            if (!data) {
                alert("Seleziona tutti e 3 i componenti per analizzare.");
                return;
            }

            placeholder.style.display = 'none';
            btn.disabled = false;
            qsPanel.classList.remove('hidden');
            
            // Update Chart
            updateChart(data.stats);

            // Calculate Grade
            const avg = (data.stats.attack + data.stats.defense + data.stats.stamina + data.stats.burstRes) / 4;
            let grade = 'C';
            let color = 'text-slate-400 border-slate-300';
            
            if (avg > 75) { grade = 'S'; color = 'text-yellow-500 border-yellow-400 bg-yellow-50'; }
            else if (avg > 65) { grade = 'A'; color = 'text-red-500 border-red-400 bg-red-50'; }
            else if (avg > 50) { grade = 'B'; color = 'text-blue-500 border-blue-400 bg-blue-50'; }

            gradeBadge.className = `w-16 h-16 rounded-full flex items-center justify-center text-3xl font-black border-4 shadow-sm ${color}`;
            gradeBadge.textContent = grade;
            gradeBadge.classList.remove('hidden');

            weightDisplay.innerText = data.raw.totalWeight.toFixed(1);

            // Generate Motivation Text
            let text = `<strong class="text-slate-800 block mb-2">Analisi Tecnica:</strong>`;
            
            // Synergy Check
            const bladeType = data.raw.bData.type;
            const bitType = data.raw.biData.type;
            const ratchetHeight = data.raw.rData.height;

            if (bladeType === 'Attack' && bitType === 'Attack') {
                text += `Sinergia eccellente tra Blade e Bit. Questa build √® un "Pure Attacker" progettato per vincere tramite Extreme Finish. `;
            } else if (bladeType === 'Defense' && bitType === 'Attack') {
                text += `Combinazione ibrida rischiosa. Usare un Bit aggressivo su una Blade difensiva pu√≤ causare auto-KO, ma offre un contrattacco sorpresa. `;
            } else if (bladeType === 'Stamina' && ratchetHeight === 'High') {
                text += `Attenzione: l'uso di un Ratchet alto su una build Stamina aumenta il rischio di Burst se colpita dal basso. `;
            } else {
                text += `Build bilanciata. Offre opzioni versatili ma potrebbe non eccellere in nessuna statistica specifica. `;
            }

            if (data.stats.weight > 80) text += `Il peso elevato la rende difficile da spingere fuori dall'arena. `;
            if (data.stats.burstRes < 40) text += `<br><span class="text-red-500 font-bold">Avviso Critico:</span> Bassa resistenza al Burst. Evita impatti diretti prolungati.`;

            analysisText.innerHTML = text;
        }

        // --- CHART JS ---
        let radarChart;

        function initChart() {
            const ctx = document.getElementById('statsRadar').getContext('2d');
            radarChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['Attacco', 'Difesa', 'Stamina', 'Peso', 'Burst Res'],
                    datasets: [{
                        label: 'Statistiche Build',
                        data: [0, 0, 0, 0, 0],
                        backgroundColor: 'rgba(37, 99, 235, 0.2)',
                        borderColor: 'rgba(37, 99, 235, 1)',
                        pointBackgroundColor: 'rgba(37, 99, 235, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            angleLines: { color: '#e2e8f0' },
                            grid: { color: '#e2e8f0' },
                            pointLabels: {
                                font: { size: 12, weight: 'bold' },
                                color: '#64748b'
                            },
                            suggestedMin: 0,
                            suggestedMax: 100
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        function updateChart(stats) {
            radarChart.data.datasets[0].data = [
                stats.attack,
                stats.defense,
                stats.stamina,
                stats.weight,
                stats.burstRes
            ];
            radarChart.update();
        }

        // --- DECK MANAGEMENT ---

        function addToDeck() {
            // Find first empty slot
            const slotIndex = state.deck.findIndex(s => s === null);
            
            if (slotIndex === -1) {
                alert("Deck pieno! Rimuovi una beyblade prima di aggiungerne un'altra.");
                return;
            }

            // Create Deck Object
            const build = {
                blade: state.currentBuild.blade,
                ratchet: state.currentBuild.ratchet,
                bit: state.currentBuild.bit,
                stats: calculateBuild().stats
            };

            state.deck[slotIndex] = build;
            renderDeck();
        }

        function removeFromDeck(index) {
            state.deck[index] = null;
            renderDeck();
        }

        function renderDeck() {
            const slots = document.querySelectorAll('.deck-slot');
            
            state.deck.forEach((build, idx) => {
                const slotEl = slots[idx];
                const emptyState = slotEl.querySelector('.empty-state');
                const filledState = slotEl.querySelector('.filled-state');

                if (build) {
                    emptyState.classList.add('hidden');
                    filledState.classList.remove('hidden');
                    
                    filledState.innerHTML = `
                        <div class="space-y-1">
                            <h4 class="font-bold text-slate-900 text-lg border-b border-slate-100 pb-1 mb-2">Build #${idx + 1}</h4>
                            <div class="text-sm"><span class="text-slate-400 w-16 inline-block">Blade:</span> <strong>${build.blade}</strong></div>
                            <div class="text-sm"><span class="text-slate-400 w-16 inline-block">Ratchet:</span> <strong>${build.ratchet}</strong></div>
                            <div class="text-sm"><span class="text-slate-400 w-16 inline-block">Bit:</span> <strong>${build.bit}</strong></div>
                            <div class="mt-3 flex gap-2 text-xs">
                                <span class="bg-red-100 text-red-700 px-2 py-1 rounded">ATK ${Math.round(build.stats.attack)}</span>
                                <span class="bg-green-100 text-green-700 px-2 py-1 rounded">STA ${Math.round(build.stats.stamina)}</span>
                            </div>
                            <button onclick="removeFromDeck(${idx})" class="mt-4 w-full text-xs text-red-400 hover:text-red-600 underline">Rimuovi</button>
                        </div>
                    `;
                    // Add subtle border color based on highest stat
                    if(build.stats.attack > 80) slotEl.classList.add('border-red-200');
                    else if(build.stats.stamina > 80) slotEl.classList.add('border-green-200');
                    else if(build.stats.defense > 80) slotEl.classList.add('border-blue-200');

                } else {
                    emptyState.classList.remove('hidden');
                    filledState.classList.add('hidden');
                    slotEl.className = "deck-slot bg-white p-6 rounded-2xl shadow border border-slate-200 min-h-[200px] flex flex-col justify-center items-center text-center relative group"; // Reset classes
                }
            });
        }

        // --- EVENTS ---

        function setupEventListeners() {
            document.getElementById('addStockBtn').addEventListener('click', () => {
                const val = document.getElementById('stockComboSelect').value;
                if (!val) return;
                addToInventory(JSON.parse(val));
            });

            const bindSelect = (id, key, descId, cat) => {
                const el = document.getElementById(id);
                el.addEventListener('change', (e) => {
                    state.currentBuild[key] = e.target.value;
                    // Update desc text
                    if(e.target.value) {
                        const info = PARTS_DB[cat][e.target.value];
                        document.getElementById(descId).textContent = info.desc || "";
                    } else {
                        document.getElementById(descId).textContent = "Seleziona...";
                    }
                });
            };

            bindSelect('build-blade', 'blade', 'desc-blade', 'blades');
            bindSelect('build-ratchet', 'ratchet', 'desc-ratchet', 'ratchets');
            bindSelect('build-bit', 'bit', 'desc-bit', 'bits');

            document.getElementById('analyzeBtn').addEventListener('click', analyzeBuild);
            
            document.getElementById('resetBuildBtn').addEventListener('click', () => {
                document.getElementById('build-blade').value = "";
                document.getElementById('build-ratchet').value = "";
                document.getElementById('build-bit').value = "";
                state.currentBuild = { blade: null, ratchet: null, bit: null };
                document.getElementById('chart-placeholder').style.display = 'flex';
                document.getElementById('analysis-text').innerHTML = '<p class="italic text-slate-400">Completa la build per ricevere il commento tecnico e la motivazione strategica.</p>';
                document.getElementById('grade-badge').classList.add('hidden');
                document.getElementById('addToDeckBtn').disabled = true;
                document.getElementById('quick-stats-panel').classList.add('hidden');
                updateChart({attack:0, defense:0, stamina:0, weight:0, burstRes:0});
            });

            document.getElementById('addToDeckBtn').addEventListener('click', addToDeck);
        }

    </script>
</body>
</html>
